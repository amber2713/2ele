<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Interactive - 1958</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Playfair Display', serif; }
        body { overflow: hidden; height: 100vh; background: #0f0f0f; color: #3E2723; }

        /* 1. 星光开场 */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a1a1a 0%, #050505 100%);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
            padding: 40px; text-align: center;
        }
        #intro-overlay::before {
            content: ""; position: absolute; width: 100%; height: 100%;
            background-image: radial-gradient(white, rgba(255,255,255,.1) 1px, transparent 30px);
            background-size: 80px 80px; opacity: 0.2; z-index: -1;
        }
        #intro-text { font-size: 1.6rem; line-height: 1.8; color: #d9c7a7; max-width: 800px; transition: opacity 0.8s; }

        /* 2. 主场景层 */
        #main-scene {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.2)), url('./images/English_center.jpg');
            background-size: cover; background-position: center; z-index: 100;
            opacity: 0; transition: opacity 1.5s ease;
        }

        /* 返回按钮 */
        .back-btn {
            position: absolute; top: 30px; left: 30px; z-index: 300;
            width: 55px; height: 55px; background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.3); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 24px; cursor: pointer; transition: all 0.3s;
        }
        .back-btn:hover { transform: scale(1.1); background: rgba(59, 130, 246, 0.6); }

        /* 信封图标 */
        .mail-btn {
            position: absolute; left: 40px; top: 50%; transform: translateY(-50%);
            width: 70px; height: 70px; background: rgba(255,255,255,0.9);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            color: #3B82F6; font-size: 30px; cursor: pointer; z-index: 200;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .mail-btn:hover { transform: translateY(-55%) scale(1.1); background: #3B82F6; color: white; }

        /* 管理员形象 */
        .librarian-img {
            position: absolute; right: 5%; bottom: 0; height: 85vh;
            z-index: 150; filter: drop-shadow(0 20px 50px rgba(0,0,0,0.5));
            pointer-events: none;
        }

        /* 对话框 */
        .chat-wrap {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 600px; z-index: 250;
        }
        .chat-container {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 20px; padding: 20px; border: 2px solid #3B82F6;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }
        .chat-messages { height: 120px; overflow-y: auto; margin-bottom: 15px; font-size: 1.1rem; color: #1a1a1a; padding-right: 10px; }
        .chat-input-area { display: flex; gap: 10px; }
        .chat-input-area input {
            flex: 1; padding: 12px 20px; border-radius: 25px; border: 1px solid #ddd;
            outline: none; font-size: 1rem;
        }
        .chat-input-area button {
            width: 45px; height: 45px; border-radius: 50%; border: none;
            background: #3B82F6; color: white; cursor: pointer; transition: 0.3s;
        }

        /* 作业模态框 */
        #assignment-modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            z-index: 2000; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.5s;
        }
        .paper-content {
            background: #fdfcf0; width: 90%; max-width: 700px; min-height: 500px;
            padding: 50px; position: relative; border-radius: 4px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            background-image: linear-gradient(#e1e1e1 1px, transparent 1px);
            background-size: 100% 1.5em; line-height: 1.5em; color: #2c3e50;
        }
        .paper-text { font-family: 'Courier New', Courier, monospace; font-size: 1.1rem; }
        .close-paper { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; color: #e74c3c; }
        .nav-arrow {
            position: absolute; top: 50%; transform: translateY(-50%);
            font-size: 40px; color: white; cursor: pointer; padding: 20px;
            transition: 0.3s;
        }
        .nav-arrow:hover { color: #3B82F6; scale: 1.2; }
        .arrow-left { left: -80px; }
        .arrow-right { right: -80px; }

        @media (max-width: 768px) {
            .nav-arrow { display: none; }
            .librarian-img { height: 50vh; }
        }
    </style>
</head>
<body>

    <div id="intro-overlay">
        <div id="intro-text"></div>
    </div>

    <div id="main-scene">
        <div class="back-btn" onclick="window.location.href='https://amber2713.github.io/sitetwo/hall/'">
            <i class="fas fa-arrow-left"></i>
        </div>

        <div class="mail-btn" onclick="openAssignments()">
            <i class="fas fa-envelope-open-text"></i>
        </div>

        <img src="./images/tushuguanliyuan.png" alt="Librarian" class="librarian-img">

        <div class="chat-wrap">
            <div class="chat-container">
                <div class="chat-messages" id="chatDisplay">
                    Welcome back. This library has stood for centuries... Is there a specific manuscript or topic you are searching for today?
                </div>
                <div class="chat-input-area">
                    <input type="text" id="userInput" placeholder="Ask the librarian..." autocomplete="off">
                    <button onclick="handleChat()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="assignment-modal">
        <div class="paper-content">
            <i class="fas fa-times-circle close-paper" onclick="closeAssignments()"></i>
            <div class="nav-arrow arrow-left" onclick="switchAssignment(-1)"><i class="fas fa-chevron-left"></i></div>
            <div class="nav-arrow arrow-right" onclick="switchAssignment(1)"><i class="fas fa-chevron-right"></i></div>
            
            <div id="paperBody" class="paper-text">
                </div>
            <img id="luckyImage" src="./images/zuoye.jpg" style="display:none; width:100%; height:100%; object-fit: contain;">
        </div>
    </div>

<script>
    /* ================= 1. 初始化控制 ================= */
    const introText = [
        "Walking through the silent corridors of history...",
        "The scent of old parchment and mahogany fills the air.",
        "A Librarian waits at the end of the hall.",
        "She guards the knowledge of a thousand years."
    ];

    async function playIntro() {
        const container = document.getElementById('intro-text');
        for (let text of introText) {
            container.style.opacity = 0;
            await new Promise(r => setTimeout(r, 500));
            container.innerText = text;
            container.style.opacity = 1;
            await new Promise(r => setTimeout(r, 2500));
        }
        
        const overlay = document.getElementById('intro-overlay');
        const main = document.getElementById('main-scene');
        overlay.style.opacity = 0;
        setTimeout(() => {
            overlay.style.display = 'none';
            main.style.display = 'block';
            setTimeout(() => main.style.opacity = 1, 50);
        }, 1000);
    }

    window.onload = playIntro;

    /* ================= 2. 聊天逻辑 ================= */
    const chatHistory = [];
    async function handleChat() {
        const input = document.getElementById('userInput');
        const display = document.getElementById('chatDisplay');
        const text = input.value.trim();
        if (!text) return;

        chatHistory.push({ role: "user", content: text });
        display.innerHTML = `<div style="color:#3B82F6"><b>You:</b> ${text}</div>`;
        input.value = '';

        const loadingDiv = document.createElement('div');
        loadingDiv.innerText = "The librarian is searching the archives...";
        display.appendChild(loadingDiv);

        try {
            const response = await fetch('/.netlify/functions/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messages: chatHistory })
            });
            const data = await response.json();
            chatHistory.push({ role: "assistant", content: data.content });
            display.innerHTML = `<div>${data.content}</div>`;
        } catch (e) {
            display.innerHTML = "She smiles faintly. 'My memory is like a dusty shelf today. Ask me something else.'";
        }
    }

    document.getElementById('userInput').addEventListener('keypress', e => {
        if(e.key === 'Enter') handleChat();
    });

    /* ================= 3. 作业/信件随机生成系统 (已集成文档内容) ================= */

// 仅列出部分示例以作展示，实际运行建议将100篇存入独立JS或完整粘贴
const realAssignments = [
    { title: "A Letter to My Teacher", content: "Dear Miss Li, I am writing to express my sincere gratitude for your guidance this semester. When I first joined your English class, I was nervous about speaking in public and struggled with grammar. You never laughed at my mistakes; instead, you patiently corrected me and encouraged me to practice more..." },
    { title: "A Letter to My Future Self", content: "Dear Future Me, I hope this letter finds you well in 2036. Are you living the life you dreamed of when you were 16? Have you achieved your goal of becoming a environmental scientist? I hope you are still passionate about protecting nature..." },
    { title: "My Unforgettable Summer Vacation", content: "Last summer vacation, I went to the countryside to visit my grandparents with my family. The air there was fresh, and the scenery was beautiful—green fields, clear rivers and lovely birds singing every morning..." },
    { title: "The Importance of Reading", content: "Reading is one of the most valuable activities in our life. It opens a new world for us and enriches our knowledge. Through reading, we can learn about different cultures, histories and sciences without traveling around the world..." },
    { title: "A Letter to My Best Friend", content: "Dear Lucy, How are you doing? I miss you so much since you moved to another city last month. I still remember the days we spent together—we walked to school every morning, shared our snacks during breaks and helped each other with homework..." }
    // ... 此处应包含文档中全部100篇内容
];

// 辅助函数：格式化作文显示
function formatAssignment(assignment) {
    const date = new Date(1950 + Math.random() * 70, Math.random() * 12).toDateString();
    return `
        <div style="text-align:right; font-size:0.9rem; margin-bottom:20px; color:#7f8c8d;">${date}</div>
        <h3 style="margin-bottom:15px; text-decoration: underline; color:#2c3e50;">Subject: ${assignment.title}</h3>
        <div style="line-height:1.6; text-align:justify;">
            ${assignment.content}
        </div>
        <br>
        <p><i>--- Collected from the Archives ---</i></p>
    `;
}

function openAssignments() {
    const modal = document.getElementById('assignment-modal');
    modal.style.display = 'flex';
    setTimeout(() => modal.style.opacity = 1, 50);
    switchAssignment(0);
}

function closeAssignments() {
    const modal = document.getElementById('assignment-modal');
    modal.style.opacity = 0;
    setTimeout(() => modal.style.display = 'none', 500);
}

function switchAssignment(dir) {
    const paper = document.getElementById('paperBody');
    const luckyImg = document.getElementById('luckyImage');
    
    // 1/200 概率展示原图 (Lucky number is 7)
    const isLucky = Math.floor(Math.random() * 200) === 7;
    
    if(isLucky) {
        paper.style.display = 'none';
        luckyImg.style.display = 'block';
        console.log("You found the hidden manuscript!");
    } else {
        luckyImg.style.display = 'none';
        paper.style.display = 'block';
        
        // 从100篇真实作文中随机选择
        const randomIndex = Math.floor(Math.random() * realAssignments.length);
        paper.innerHTML = formatAssignment(realAssignments[randomIndex]);
    }
}
</script>
</body>
</html>

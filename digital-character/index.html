<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qwen x Pollinations 赛博人生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .cyber-bg { background: radial-gradient(circle at center, #1e1b4b 0%, #020617 100%); }
        .neon-border { border: 2px solid #8b5cf6; box-shadow: 0 0 15px #8b5cf6; }
        .loading-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } }
    </style>
</head>
<body class="cyber-bg text-white min-h-screen p-6">

    <div class="max-w-3xl mx-auto text-center">
        <h1 class="text-4xl font-extrabold mb-2 tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-400">
            BUILD YOUR DIGITAL CHARACTER
        </h1>
        <p class="text-slate-400 mb-8 font-mono text-sm">Powered by Qwen 1.7B & Pollinations AI</p>

        <div class="flex flex-col md:flex-row gap-4 mb-8">
            <input type="text" id="kw1" placeholder="核心特征" class="flex-1 p-3 rounded bg-slate-800 border border-slate-700">
            <input type="text" id="kw2" placeholder="服装/配件" class="flex-1 p-3 rounded bg-slate-800 border border-slate-700">
            <input type="text" id="kw3" placeholder="动作/背景" class="flex-1 p-3 rounded bg-slate-800 border border-slate-700">
        </div>

        <button onclick="generateAll()" id="genBtn" class="w-full bg-purple-600 hover:bg-purple-700 p-4 rounded-lg font-bold text-xl shadow-lg transition-all active:scale-95">
            初始化数字人
        </button>

        <div id="resultArea" class="mt-12 hidden space-y-8">
            <div class="relative inline-block">
                <img id="outputImg" src="" class="mx-auto rounded-xl neon-border max-w-full md:max-w-sm">
                <div id="imgLoader" class="absolute inset-0 flex items-center justify-center bg-slate-900 bg-opacity-80 rounded-xl">
                    <span class="loading-dots text-purple-400 font-mono">正在构建赛博视觉数据</span>
                </div>
            </div>

            <div class="bg-slate-800 bg-opacity-50 p-8 rounded-2xl border border-slate-700 backdrop-blur-md">
                <div id="outputPoem" class="text-2xl font-serif text-cyan-300 mb-6 leading-relaxed"></div>
                <div class="h-px bg-slate-700 w-full mb-6"></div>
                <div id="outputTrans" class="text-slate-400 italic font-light"></div>
            </div>
        </div>
    </div>

    <script>
        async function generateAll() {
            const btn = document.getElementById('genBtn');
            const resultArea = document.getElementById('resultArea');
            const imgLoader = document.getElementById('imgLoader');
            const kws = [document.getElementById('kw1').value, document.getElementById('kw2').value, document.getElementById('kw3').value].filter(v => v.trim() !== "");

            if(kws.length < 1) return alert("请输入关键词");

            btn.innerText = "Qwen 正在计算提示词...";
            btn.disabled = true;
            resultArea.classList.add('hidden');
            imgLoader.classList.remove('hidden');

            try {
                // 1. 从后端函数获取优化后的内容
                const res = await fetch('/.netlify/functions/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ keywords: kws })
                });
                const data = await res.json();

                if(data.error) throw new Error(data.error);

                // 2. 显示文字
                document.getElementById('outputPoem').innerText = data.poem;
                document.getElementById('outputTrans').innerText = data.trans;
                resultArea.classList.remove('hidden');

                // 3. 调用 Pollinations 生成图片 (512x1024 全身比例)
                const imgPrompt = encodeURIComponent(`(full body shot), cyberpunk digital human, ${data.imgP}`);
                const seed = Math.floor(Math.random() * 99999);
                const imageUrl = `https://image.pollinations.ai/prompt/${imgPrompt}?width=512&height=1024&nologo=true&model=flux&seed=${seed}`;
                
                const imgNode = document.getElementById('outputImg');
                imgNode.src = imageUrl;
                imgNode.onload = () => imgLoader.classList.add('hidden');

            } catch (e) {
                alert("发生错误: " + e.message);
            } finally {
                btn.innerText = "重新生成";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>

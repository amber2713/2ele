<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1958 Café - A Timeless Experience</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 你的 style 原封不动 -->
    <style>
        /* ⚠️ 此处省略：你的 CSS 不需要改，直接保持原样 */
    </style>
</head>

<body>
    <!-- ========== 你的 HTML 结构完全不动 ========== -->

    <!-- 咖啡厅内部视图 -->
    <div class="inside-space" id="insideSpace">
        <div class="inside-header">
            <h2 class="inside-title">Call Me USTC</h2>
        </div>

        <div class="inside-content">
            <div class="girl-container">
                <img src="images/barista.jpg" alt="Friendly Barista" class="girl">
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message bot">
                        咖啡已经放了一会儿了，不过你来得正好。
                    </div>
                </div>

                <div class="chat-input">
                    <input type="text" id="userInput" placeholder="Type your message here..." autocomplete="off">
                    <button onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
/* ================= 核心改动从这里开始 ================= */

// 多轮对话上下文
const chatHistory = [];

// 添加消息
function addMessage(text, sender) {
    const chatMessages = document.getElementById('chatMessages');
    const div = document.createElement('div');
    div.className = 'message ' + sender;
    div.textContent = text;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    return div;
}

// 打字机效果
function typeWriter(element, text, speed = 35) {
    element.textContent = '';
    let i = 0;
    function typing() {
        if (i < text.length) {
            element.textContent += text.charAt(i++);
            setTimeout(typing, speed);
        }
    }
    typing();
}

// 发送消息（真正调用 Netlify 后端）
async function sendMessage() {
    const input = document.getElementById('userInput');
    const message = input.value.trim();
    if (!message) return;

    addMessage(message, 'user');
    chatHistory.push({ role: 'user', content: message });
    input.value = '';

    const botDiv = addMessage('……', 'bot');

    try {
        const res = await fetch('/.netlify/functions/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                messages: chatHistory
            })
        });

        if (!res.ok) throw new Error(res.status);

        const data = await res.json();
        chatHistory.push({ role: 'assistant', content: data.content });

        typeWriter(botDiv, data.content);

    } catch (err) {
        console.error(err);
        botDiv.textContent = '……咖啡馆的灯轻轻闪了一下。';
    }
}

// 回车发送
document.getElementById('userInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') sendMessage();
});
</script>
</body>
</html>
